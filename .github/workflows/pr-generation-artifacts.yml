name: PR Generation Artifacts

on:
  pull_request:

permissions:
  contents: read
  pull-requests: write

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - run: npm ci
      - run: |
          node index.js -w 256 -h 256 -s checkers
          node index.js -w 256 -h 256 -s stripes
          node index.js -w 256 -h 256 -s diamonds
          node index.js -w 256 -h 256 -s circle
      - id: upload-checkers
        uses: actions/upload-artifact@v4
        with:
          name: checkers-generation
          path: output/checkers_1px_256x256.png
          compression-level: 0
      - id: upload-stripes
        uses: actions/upload-artifact@v4
        with:
          name: stripes-generation
          path: output/stripes_1px_256x256.png
          compression-level: 0
      - id: upload-diamonds
        uses: actions/upload-artifact@v4
        with:
          name: diamonds-generation
          path: output/diamonds_1px_256x256.png
          compression-level: 0
      - id: upload-circle
        uses: actions/upload-artifact@v4
        with:
          name: circle-generation
          path: output/circle_1px_256x256.png
          compression-level: 0
      - uses: actions/github-script@v7
        with:
          script: |
            const marker = '<!-- pr-generation-artifacts -->';
            const body = `${marker}
            ðŸ–¼ï¸ Generated image artifacts are ready:
            - [checkers_1px_256x256.png](${{ steps.upload-checkers.outputs.artifact-url }})
            - [stripes_1px_256x256.png](${{ steps.upload-stripes.outputs.artifact-url }})
            - [diamonds_1px_256x256.png](${{ steps.upload-diamonds.outputs.artifact-url }})
            - [circle_1px_256x256.png](${{ steps.upload-circle.outputs.artifact-url }})`;

            const { owner, repo } = context.repo;
            const issue_number = context.payload.pull_request.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner,
              repo,
              issue_number
            });
            const existing = comments.find((comment) => comment.body && comment.body.includes(marker));
            if (existing) {
              await github.rest.issues.updateComment({
                owner,
                repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number,
                body
              });
            }
